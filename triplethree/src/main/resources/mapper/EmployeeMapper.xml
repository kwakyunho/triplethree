<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="shop.triplethree.mapper.EmployeeMapper">

	<select id="login" parameterType="shop.triplethree.vo.Employee" resultType="shop.triplethree.vo.Employee">
		SELECT 
			em.code,
			em.emp_num as empNum,
			em.emp_name as empName,
			em.PASSWORD,
			de.dename as demgCode,
			po.poname as poCode,
			em.email,
			em.phone,
			em.addr,
			em.photo
			
		FROM
			EMP_MANAGE AS em
			JOIN DEMG AS de
			JOIN POSISYS AS po
		ON em.demgcode = de.CODE AND em.pocode = po.CODE
		WHERE em.emp_num = #{empNum} 
			and em.demgcode = de.CODE
 			AND em.pocode = po.CODE
		
			GROUP BY em.emp_num
	</select>
	
	<select id="selectForDepart" resultType="shop.triplethree.vo.Employee">
		SELECT
			 de.dename as demgCode,
			 de.code as code
		FROM
			 DEMG AS de
	    where de.approver_st = 'Y'
	</select>
	
	<select id="selectForPosition" resultType="shop.triplethree.vo.Employee">
		SELECT
			po.CODE AS code,
			po.poname AS poCode
		FROM
			POSISYS AS po
		WHERE 
			po.approver_st = 'Y'
	</select>
	
	<select id="selectForStatus" resultType="shop.triplethree.vo.Employee">
		SELECT
			li.CODE as code,
			li.s_section as liCode 
		FROM
		 	LIST_MANAGE AS li
		 WHERE li.m_section='재직여부' AND li.yes_or_no='Y'
	</select>
	
	<insert id="insertEmployee" parameterType="shop.triplethree.vo.Employee">
		INSERT INTO EMP_MANAGE (emp_num,CODE,demgcode,pocode,li_code,emp_name,password,addr,phone,car_presence,email,
								birth_date,con_type,basic_pay,join_date,photo,signature,retire_date,writer,writer_day)

			SELECT CONCAT('TT', DATE_FORMAT(CURDATE(),'%Y%m%d'), LPAD(RIGHT(IFNULL(MAX(emp_num), 0),3)+1,3,0)) AS emp_num, 
				    #{code} as CODE, 
				    #{demgCode} as demgcode,  
			        #{poCode} as pocode, 
			        #{liCode} as li_code, 
			        #{empName} as emp_name, 
			        #{password} as password, 
			        #{addr} as addr, 
			        #{phone} as phone, 
			        #{carPresence} as car_presence, 
			        #{email} as email, 
			        #{birthDate} as birth_date, 
			        #{conType} as con_type, 
			        #{basicPay} as basic_pay, 
			        #{joinDate} as join_date, 
			        #{photo} as photo, 
			        #{signature} as signature, 
			        #{retireDate} as retire_date, 
			        #{writer} as writer, 
			        now() as writer_day 
			        
			FROM EMP_MANAGE
			WHERE emp_num LIKE (
				CONCAT('TT', DATE_FORMAT(CURDATE(),'%Y%m%d'),'%')
			)
	</insert>
	
	<select id="selectEmployee" resultType="shop.triplethree.vo.Employee">
		<!-- SELECT 
			
			em.emp_num as empNum,
			em.emp_name AS empName,
			de.dename AS demgCode,
			po.poname AS poCode,
			em.email AS email,
			em.car_presence AS carPresence,
			li.s_section AS liCode
		FROM
			EMP_MANAGE AS em
			JOIN DEMG AS de
			JOIN POSISYS AS po
			JOIN LIST_MANAGE AS li
		ON em.demgcode = de.CODE AND em.pocode = po.CODE AND em.li_code = li.code
		
		WHERE
			em.writer_day in
			(
		SELECT
			MAX(e.writer_day) AS date
		FROM
			EMP_MANAGE AS e
		GROUP BY
			e.emp_name) -->
			
			SELECT
				 em.CODE,
			  	 de.dename AS demgCode,
			     po.poname AS poCode,
				 li.s_section AS liCode, 
				 em.emp_num AS empNum, 
				 em.emp_name AS empName, 
				 em.email AS email,
				 em.car_presence AS carPresence, 
				 MAX(em.writer_day)
			FROM 
				EMP_MANAGE em, DEMG de, POSISYS po, LIST_MANAGE li
				WHERE em.demgcode = de.CODE
				AND em.pocode = po.CODE
				AND em.li_code = li.code
				GROUP BY em.emp_num
						
				
	</select>
	
	<select id="selectForDetail" parameterType="String" resultType="shop.triplethree.vo.Employee">
		
		SELECT 
			em.photo as photo,
			em.signature as signature,
			em.emp_num as empNum,
			em.emp_name as empName,
			em.addr as addr,
			em.phone as phone,
			em.car_presence as carPresence,
			em.email as email,
			date_format(em.birth_date,'%Y-%m-%d') as birthDate,
			de.dename as demgName,
			po.poname as poName,
			li.s_section as liName,
			em.con_type as conType,
			em.basic_pay as basicPay,
			DATE_FORMAT(em.join_date,'%Y-%m-%d') as joinDate,
			DATE_FORMAT(em.retire_date,'%Y-%m-%d') as retireDate,
			em.writer as writer,
			DATE_FORMAT(em.writer_day,'%Y-%m-%d') as writerDay
		FROM
			EMP_MANAGE AS em
			JOIN DEMG AS de
			JOIN POSISYS AS po
			JOIN LIST_MANAGE AS li
		ON em.demgcode = de.CODE AND em.pocode = po.CODE AND em.li_code = li.code
		WHERE em.emp_num = #{empNum}
		ORDER BY
			em.writer_day DESC
		LIMIT 1;
			
		
	</select>
	
	<select id="selectForUpdate" parameterType="String" resultType="shop.triplethree.vo.Employee">
		
		SELECT 
			em.photo as photo,
			em.signature as signature,
			em.emp_num as empNum,
			em.emp_name as empName,
			em.password as password,
			em.addr as addr,
			em.phone as phone,
			em.car_presence as carPresence,
			em.email as email,
			date_format(em.birth_date,'%Y-%m-%d') as birthDate,
			de.dename as demgName,
			po.poname as poName,
			li.s_section as liName,
			em.con_type as conType,
			em.basic_pay as basicPay,
			DATE_FORMAT(em.join_date,'%Y-%m-%d') as joinDate,
			DATE_FORMAT(em.retire_date,'%Y-%m-%d') as retireDate,
			em.writer as writer,
			DATE_FORMAT(em.writer_day,'%Y-%m-%d') as writerDay
		FROM
			EMP_MANAGE AS em
			JOIN DEMG AS de
			JOIN POSISYS AS po
			JOIN LIST_MANAGE AS li
		ON em.demgcode = de.CODE AND em.pocode = po.CODE AND em.li_code = li.code
		WHERE em.emp_num = #{empNum}
		ORDER BY
			em.writer_day DESC
		LIMIT 1

	
		
	</select>
	
	<insert id="updateEmployee" parameterType="shop.triplethree.vo.Employee">
		INSERT INTO EMP_MANAGE (code, demgcode, pocode, li_code, emp_num, emp_name, password, 
								addr, phone, car_presence, email, birth_date, con_type, basic_pay,
								join_date, photo, signature, writer, writer_day)
			VALUES (
					#{code},
					#{demgCode},
					#{poCode},
					#{liCode},
					#{empNum},
					#{empName},
					#{password},
					#{addr},
					#{phone},
					#{carPresence},
					#{email},
					#{birthDate},
					#{conType},
					#{basicPay},
					#{joinDate},
					#{photo},
					#{signature},
					#{writer},
					 NOW())
			 
		<if test="retireDate neq null and retireDate neq ''.toString()">
 				INSERT INTO EMP_MANAGE (code, demgcode, pocode, li_code, emp_num, emp_name, password, 
								addr, phone, car_presence, email, birth_date, con_type, basic_pay,
								join_date, photo, signature, retire_date, writer, writer_day)
				VALUES (
						#{code},
						#{demgCode},
						#{poCode},
						#{liCode},
						#{empNum},
						#{empName},
						#{password},
						#{addr},
						#{phone},
						#{carPresence},
						#{email},
						#{birthDate},
						#{conType},
						#{basicPay},
						#{joinDate},
						#{photo},
						#{signature},
						#{retireDate},
						#{writer},
						 NOW())
 			</if>
	</insert>
	
</mapper>